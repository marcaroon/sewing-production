// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Buyer Model (unchanged)
model Buyer {
  id                String   @id @default(cuid())
  name              String
  type              String
  code              String   @unique
  contactPerson     String?
  phone             String?
  canReuse          Boolean  @default(false)
  returRequired     Boolean  @default(false)
  storageLocation   String?
  orders            Order[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([type])
  @@map("buyers")
}

// Style Model (unchanged)
model Style {
  id                    String   @id @default(cuid())
  styleCode             String   @unique
  name                  String
  category              String
  description           String?  @db.Text
  imageUrl              String?
  estimatedCuttingTime  Int?
  estimatedSewingTime   Int?
  orders                Order[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([category])
  @@map("styles")
}

// Order Model - UPDATED
model Order {
  id                    String   @id @default(cuid())
  orderNumber           String   @unique
  buyerId               String
  styleId               String
  article               String?
  orderDate             DateTime
  
  // TWO DEADLINES
  productionStartedAt   DateTime?
  productionDeadline    DateTime  // Deadline untuk selesai produksi
  deliveryDeadline      DateTime  // Deadline untuk pengiriman ke buyer
  
  totalQuantity         Int
  
  // CURRENT STATE
  currentPhase          String   @default("production") // "production" or "delivery"
  currentProcess        String   @default("draft")      // process name
  currentState          String   @default("at_ppic")    // "at_ppic", "waiting", "assigned", "in_progress", "completed"

  processFlow String?
  processTemplate String?
  totalProcessSteps Int @default(0)

  assignedLine          String?
  assignedTo            String?   // operator/PIC yang sedang handle
  materialsIssued       Boolean  @default(false)
  
  totalCompleted        Int      @default(0)
  totalRejected         Int      @default(0)
  totalRework           Int      @default(0)
  
  hasLeftover           Boolean  @default(false)
  createdBy             String
  notes                 String?  @db.Text
  
  // Relations
  buyer                 Buyer    @relation(fields: [buyerId], references: [id])
  style                 Style    @relation(fields: [styleId], references: [id])
  
  transferLogs          TransferLog[]
  sizeBreakdowns        SizeBreakdown[]
  processSteps          ProcessStep[]
  processTransitions    ProcessTransition[]
  rejectLogs            RejectLog[]
  leftoverMaterials     LeftoverMaterial[]
  bundles               Bundle[]
  qrCode                OrderQRCode?
  orderMaterials        OrderMaterial[]
  orderAccessories      OrderAccessory[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([buyerId])
  @@index([styleId])
  @@index([currentPhase])
  @@index([currentProcess])
  @@index([currentState])
  @@index([orderDate])
  @@index([productionDeadline])
  @@index([deliveryDeadline])
  @@map("orders")
}

// ==================== INVENTORY MODELS ====================

// Material Master (Bahan Baku)
model Material {
  id                String   @id @default(cuid())
  materialCode      String   @unique
  name              String
  category          String   // "fabric", "thread", "interlining", etc
  unit              String   // "meter", "yard", "kg", "roll"
  color             String?
  supplier          String?
  minimumStock      Float    @default(0)
  reorderPoint      Float    @default(0)
  unitPrice         Float?
  
  stockTransactions MaterialStockTransaction[]
  orderMaterials    OrderMaterial[]
  materialUsages    MaterialUsage[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([category])
  @@map("materials")
}

// Accessory Master (Aksesoris)
model Accessory {
  id                String   @id @default(cuid())
  accessoryCode     String   @unique
  name              String
  category          String   // "button", "zipper", "label", "thread", etc
  unit              String   // "pcs", "dozen", "gross", "meter"
  color             String?
  size              String?
  supplier          String?
  minimumStock      Int      @default(0)
  reorderPoint      Int      @default(0)
  unitPrice         Float?
  
  stockTransactions AccessoryStockTransaction[]
  orderAccessories  OrderAccessory[]
  accessoryUsages   AccessoryUsage[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([category])
  @@map("accessories")
}

// Material Stock Transactions (In/Out)
model MaterialStockTransaction {
  id              String   @id @default(cuid())
  materialId      String
  transactionType String   // "in" (purchase), "out" (issue), "adjustment", "return"
  quantity        Float
  unit            String
  referenceType   String?  // "purchase", "order", "adjustment"
  referenceId     String?  // PO number, order ID, etc
  remarks         String?
  performedBy     String
  transactionDate DateTime @default(now())
  
  material        Material @relation(fields: [materialId], references: [id])
  
  createdAt       DateTime @default(now())

  @@index([materialId])
  @@index([transactionDate])
  @@map("material_stock_transactions")
}

// Accessory Stock Transactions
model AccessoryStockTransaction {
  id              String   @id @default(cuid())
  accessoryId     String
  transactionType String   // "in", "out", "adjustment", "return"
  quantity        Int
  unit            String
  referenceType   String?
  referenceId     String?
  remarks         String?
  performedBy     String
  transactionDate DateTime @default(now())
  
  accessory       Accessory @relation(fields: [accessoryId], references: [id])
  
  createdAt       DateTime @default(now())

  @@index([accessoryId])
  @@index([transactionDate])
  @@map("accessory_stock_transactions")
}

// Order Materials (Required materials per order)
model OrderMaterial {
  id                String   @id @default(cuid())
  orderId           String
  materialId        String
  quantityRequired  Float    // Total required
  quantityIssued    Float    @default(0) // Actually issued from warehouse
  quantityUsed      Float    @default(0) // Used in production
  quantityReturned  Float    @default(0) // Returned to warehouse
  quantityWasted    Float    @default(0) // Wasted/damaged
  unit              String
  notes             String?
  
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  material          Material @relation(fields: [materialId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([orderId])
  @@index([materialId])
  @@map("order_materials")
}

// Order Accessories (Required accessories per order)
model OrderAccessory {
  id                String   @id @default(cuid())
  orderId           String
  accessoryId       String
  quantityRequired  Int      // Total required (e.g., buttons = totalQty * buttonsPerPiece)
  quantityIssued    Int      @default(0)
  quantityUsed      Int      @default(0)
  quantityReturned  Int      @default(0)
  quantityWasted    Int      @default(0)
  unit              String
  notes             String?
  
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  accessory         Accessory @relation(fields: [accessoryId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([orderId])
  @@index([accessoryId])
  @@map("order_accessories")
}

// Material Usage per Process Step
model MaterialUsage {
  id              String   @id @default(cuid())
  processStepId   String
  materialId      String
  quantityUsed    Float
  quantityWasted  Float    @default(0)
  unit            String
  usedBy          String
  usageDate       DateTime @default(now())
  notes           String?
  
  processStep     ProcessStep @relation(fields: [processStepId], references: [id], onDelete: Cascade)
  material        Material    @relation(fields: [materialId], references: [id])
  
  createdAt       DateTime @default(now())

  @@index([processStepId])
  @@index([materialId])
  @@map("material_usages")
}

// Accessory Usage per Process Step
model AccessoryUsage {
  id              String   @id @default(cuid())
  processStepId   String
  accessoryId     String
  quantityUsed    Int
  quantityWasted  Int      @default(0)
  unit            String
  usedBy          String
  usageDate       DateTime @default(now())
  notes           String?
  
  processStep     ProcessStep @relation(fields: [processStepId], references: [id], onDelete: Cascade)
  accessory       Accessory   @relation(fields: [accessoryId], references: [id])
  
  createdAt       DateTime @default(now())

  @@index([processStepId])
  @@index([accessoryId])
  @@map("accessory_usages")
}

model TransferLog {
  id                String   @id @default(cuid())
  transferNumber    String   @unique // TRF-2024-00001
  
  orderId           String
  processStepId     String   // Process step yang selesai
  
  fromProcess       String   // Process name yang selesai
  fromDepartment    String
  toProcess         String   // Process name berikutnya
  toDepartment      String
  
  transferDate      DateTime @default(now())
  handedOverBy      String
  receivedBy        String?  // Null until received
  
  // Quantities transferred
  quantityTransferred Int
  quantityCompleted   Int     // dari process sebelumnya
  quantityRejected    Int
  quantityRework      Int
  
  // Rejection details (JSON)
  rejectSummary     String?  @db.Text // JSON array of reject details
  
  // Duration info
  processingDuration Int?    // minutes
  waitingDuration    Int?    // minutes
  
  // Status
  status            String   @default("pending") // "pending", "received", "disputed"
  isReceived        Boolean  @default(false)
  receivedDate      DateTime?
  
  // Notes & Issues
  notes             String?  @db.Text
  issues            String?  @db.Text // Any problems/damages noted
  
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  processStep       ProcessStep @relation(fields: [processStepId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([orderId])
  @@index([processStepId])
  @@index([transferDate])
  @@index([status])
  @@map("transfer_logs")
}

// Size Breakdown Model (unchanged)
model SizeBreakdown {
  id          String   @id @default(cuid())
  orderId     String
  size        String
  quantity    Int
  completed   Int      @default(0)
  rejected    Int      @default(0)
  bundleCount Int      @default(0)
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([size])
  @@map("size_breakdowns")
}

// NEW: Process Step Configuration
// Defines each step in production and delivery
model ProcessStep {
  id                    String   @id @default(cuid())
  orderId               String
  processName           String   // "cutting", "numbering", "sewing", etc.
  processPhase          String   // "production" or "delivery"
  sequenceOrder         Int      // urutan process (1, 2, 3, dst)
  department            String   // department yang handle
  
  // Status
  status                String   @default("pending") // "pending", "in_progress", "completed", "on_hold"
  
  // Assignment
  assignedTo            String?  // PIC/Operator
  assignedLine          String?  // untuk sewing
  
  // Timestamps - DETAIL
  arrivedAtPpicTime     DateTime? // Kapan sampai di PPIC
  addedToWaitingTime    DateTime? // Kapan masuk waiting list
  assignedTime          DateTime? // Kapan di-assign ke operator
  startedTime           DateTime? // Kapan mulai dikerjakan
  completedTime         DateTime? // Kapan selesai
  
  // Quantities
  quantityReceived      Int      @default(0)
  quantityCompleted     Int      @default(0)
  quantityRejected      Int      @default(0)
  quantityRework        Int      @default(0)
  
  // Duration tracking (in minutes)
  waitingDuration       Int?     // Lama di waiting list
  processingDuration    Int?     // Lama dikerjakan
  totalDuration         Int?     // Total waktu dari terima sampai selesai
  
  notes                 String?  @db.Text
  
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  transitions           ProcessTransition[]
  rejects               RejectLog[]
  transferLogs          TransferLog[]
  materialUsages        MaterialUsage[]
  accessoryUsages       AccessoryUsage[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([orderId])
  @@index([processName])
  @@index([processPhase])
  @@index([status])
  @@index([sequenceOrder])
  @@map("process_steps")
}

// NEW: Process Transition Log
// Records every state change with timestamp
model ProcessTransition {
  id                String   @id @default(cuid())
  orderId           String
  processStepId     String
  
  fromState         String   // "at_ppic", "waiting", "assigned", "in_progress", "completed"
  toState           String
  
  transitionTime    DateTime @default(now())
  performedBy       String   // Who performed the transition
  
  // Context
  processName       String   // untuk quick reference
  department        String
  
  // Additional data
  quantity          Int?     // jumlah yang ditransfer
  notes             String?  @db.Text
  
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  processStep       ProcessStep @relation(fields: [processStepId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())

  @@index([orderId])
  @@index([processStepId])
  @@index([transitionTime])
  @@index([fromState])
  @@index([toState])
  @@map("process_transitions")
}

// UPDATED: Reject Log - Per Process
model RejectLog {
  id                String   @id @default(cuid())
  orderId           String
  processStepId     String   // Which process step
  
  processName       String   // "cutting", "sewing", etc
  processPhase      String   // "production" or "delivery"
  
  detectedTime      DateTime @default(now())
  reportedBy        String
  
  rejectType        String   // "material_defect", "cutting_error", "sewing_defect", "measurement_error", etc
  rejectCategory    String   // "reject" or "rework"
  
  quantity          Int
  size              String?
  bundleNumber      String?
  
  description       String   @db.Text
  rootCause         String?  @db.Text
  
  // Action taken
  action            String   // "rework", "scrap", "pending"
  actionTakenBy     String?
  actionTakenTime   DateTime?
  
  // Resolution
  reworkCompleted   Boolean  @default(false)
  reworkCompletedTime DateTime?
  finalDisposition  String?  // "passed", "scrapped", "pending"
  
  images            String?  @db.Text // JSON array
  
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  processStep       ProcessStep @relation(fields: [processStepId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([orderId])
  @@index([processStepId])
  @@index([detectedTime])
  @@index([rejectCategory])
  @@map("reject_logs")
}

// Leftover Material Model (unchanged)
model LeftoverMaterial {
  id              String   @id @default(cuid())
  orderId         String
  orderNumber     String
  buyerId         String
  buyerType       String
  status          String
  storageLocation String?
  notes           String?  @db.Text
  materials       String   @db.Text
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@map("leftover_materials")
}

// Sewing Line Model (unchanged)
model SewingLine {
  id          String   @id @default(cuid())
  lineName    String
  lineCode    String   @unique
  capacity    Int
  currentLoad Int      @default(0)
  operators   Int
  supervisor  String
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@map("sewing_lines")
}

// Bundle Model (unchanged)
model Bundle {
  id              String   @id @default(cuid())
  bundleNumber    String   @unique
  orderId         String
  size            String
  quantity        Int
  currentLocation String
  currentStatus   String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  qrCode          BundleQRCode?
  createdAt       DateTime @default(now())
  lastUpdated     DateTime @updatedAt

  @@index([orderId])
  @@index([currentStatus])
  @@map("bundles")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String   // Hashed password
  name          String
  department    String
  role          String   // "admin", "ppic", "cutting", "sewing", "qc", "warehouse", "packing", "shipping"
  
  // Auth fields
  emailVerified Boolean  @default(false)
  isActive      Boolean  @default(true)
  isAdmin       Boolean  @default(false)
  lastLogin     DateTime?
  
  // Profile
  phone         String?
  avatar        String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([department])
  @@index([role])
  @@index([isActive])
  @@index([isAdmin])
  @@map("users")
}

// Session Model untuk track login sessions
model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// QR Code Models (unchanged)
model OrderQRCode {
  id          String   @id @default(cuid())
  orderId     String   @unique
  qrCode      String   @unique
  qrData      String   @db.Text
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  scans       QRScan[]
  createdAt   DateTime @default(now())
  
  @@index([qrCode])
  @@map("order_qr_codes")
}

model BundleQRCode {
  id          String   @id @default(cuid())
  bundleId    String   @unique
  qrCode      String   @unique
  qrData      String   @db.Text
  bundle      Bundle   @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  scans       QRScan[]
  createdAt   DateTime @default(now())
  
  @@index([qrCode])
  @@map("bundle_qr_codes")
}

model QRScan {
  id            String   @id @default(cuid())
  qrCode        String
  qrType        String
  orderQRId     String?
  bundleQRId    String?
  scannedBy     String
  scannedAt     DateTime @default(now())
  location      String
  action        String
  notes         String?  @db.Text
  deviceInfo    String?
  orderQR       OrderQRCode?  @relation(fields: [orderQRId], references: [id], onDelete: Cascade)
  bundleQR      BundleQRCode? @relation(fields: [bundleQRId], references: [id], onDelete: Cascade)
  
  @@index([qrCode])
  @@index([scannedAt])
  @@map("qr_scans")
}